# 多邻记 (DuoRecall) 设计文档

**日期**: 2026-01-31
**版本**: 1.0
**状态**: 待评审

---

## 1. 项目概述

多邻记是一个记忆卡片管理应用，可以将多邻国导出的记忆卡片批量导入，利用 AI 进行中英文识别和自动分类，方便用户管理和复习。

### 1.1 核心特性
- 批量导入多邻国 APP 导出的句子图片或做题过程中的截屏图片
- 利用 AI 识别图片中的中英文文本，自动分类（场景、时态、短语类型）
- 多种复习方式：按场景、按时态、按时间
- 复习过程中可随时调用 AI 解析句子，分析错误原因，展开中英文对话
- 本地存储，支持数据导出（CSV、JSON、PDF）
- Android 平台支持悬浮窗功能，一键导入

### 1.2 目标平台
- Android
- iOS
- Web

---

## 2. 整体架构

### 2.1 架构分层

多邻记采用分层架构设计，自上而下分为表现层、业务逻辑层、数据层和基础设施层。

**表现层**
- 使用 Flutter 构建，采用 Material Design 3 设计语言
- 主界面采用底部导航栏结构，分为四个核心页面：卡片库、AI 识别中心、复习模式、数据管理
- Android 平台实现悬浮窗组件，支持从多邻国 APP 侧边一键抓取

**业务逻辑层**
- 采用 Provider + Riverpod 进行状态管理
- 包含六大核心模块：卡片管理、AI 智能处理、复习调度、用户偏好设置、统计分析、悬浮窗控制

**数据层**
- 采用 sqflite（移动端）+ web_sqlite（Web 端）双策略
- 通过仓储模式封装数据库操作，保证平台无关性
- 支持增量备份和完整数据导出

**基础设施层**
- 集成硅基流动 AI 服务，使用 OpenAI 兼容接口
- API Key 通过环境变量管理 + 运行时解密
- 使用 dio 封装网络请求，支持重试、超时控制和错误日志

### 2.2 技术栈

**核心框架**
- Flutter SDK：3.10.7+
- Dart 语言：支持空安全

**状态管理**
- riverpod：2.4.9
- flutter_riverpod：2.4.9
- riverpod_annotation：2.3.3

**数据存储**
- sqflite：2.3.0
- sqflite_common_ffi：2.3.0
- path_provider：2.1.1
- path：1.8.3

**网络请求**
- dio：5.4.0
- connectivity_plus：5.0.2

**图片处理**
- image_picker：1.0.4
- cached_network_image：3.3.0
- image：4.1.3

**UI 组件**
- flutter_svg：2.0.9
- flutter_markdown：0.6.14
- shimmer：3.0.0

**悬浮窗（Android）**
- flutter_overlay_window：0.4.0
- permission_handler：11.0.1

**数据导出**
- csv：5.1.1
- pdf：3.10.7
- share_plus：7.2.1

**国际化**
- flutter_localizations
- intl：0.18.1

**测试**
- flutter_test
- integration_test
- mockito：5.4.4
- build_runner：2.4.7

---

## 3. 核心功能模块

### 3.1 卡片库模块

**导入方式**
- 批量导入：使用 image_picker 选择多张图片，自动触发 AI 识别
- 悬浮窗导入（Android）：侧边显示半透明悬浮按钮，点击触发屏幕截图

**卡片展示**
- 网格视图展示，每张卡片显示缩略图、中英文文本、AI 标签、识别置信度
- 支持卡片编辑、删除、合并重复卡片
- 搜索栏支持按文本、标签、时间筛选

**数据结构**
```dart
class FlashCard {
  final String id;
  final String imagePath;
  final String chineseText;
  final String englishText;
  final List<String> tags; // 场景、时态等
  final double confidence;
  final DateTime createTime;
  final int reviewCount;
  final DateTime? nextReviewTime;
}
```

### 3.2 AI 识别中心

**识别流程**
1. 图像 OCR 提取中英文文本
2. NLP 分析提取语言特征（场景、时态、短语类型）
3. 生成卡片元数据并存储

**识别模式**
- 批量识别：通过 isolate 多线程处理，避免阻塞 UI
- 单张重新识别：支持手动修正后重新识别

**AI 对话**
- 针对任意卡片发起对话
- 对话历史自动保存
- 支持导出为文本文件

### 3.3 复习模式模块

**复习策略**
- 按场景复习：筛选特定场景的卡片，按最近学习时间排序
- 按时态复习：筛选特定时态的卡片，支持混合时态模式
- 按时间复习：提供时间范围选择，按遗忘曲线算法推荐

**复习界面**
- 翻转卡片设计，正面显示问题，背面显示答案和 AI 解析
- 三个评价按钮：记住（绿色）、模糊（黄色）、忘记（红色）
- 点击"忘记"触发错误分析侧边栏

**错误分析**
- 侧边栏从右侧滑出，包含错误分析报告、AI 对话历史、相关知识点推荐
- 支持手势拖动关闭

### 3.4 数据管理模块

**数据导出**
- CSV：适合 Excel 查看和编辑
- JSON：保留完整数据结构，适合备份
- PDF：可打印文档，支持按场景/时态分组

**数据导入**
- 支持 JSON 备份文件恢复
- 导入前显示预览和冲突处理选项

**数据清理**
- 删除指定时间范围的卡片
- 清除复习记录
- 压缩数据库

---

## 4. 数据流与状态管理

### 4.1 数据流设计

采用单向数据流模式：
1. 用户操作触发事件
2. 事件通过 Provider/Riverpod 分发到 Reducer 或 Notifier
3. 状态更新后自动触发 UI 重建

### 4.2 状态管理

**Provider 层级**
- 全局 Provider：应用主题、用户偏好、数据库连接
- 功能模块 Provider：卡片库、AI 识别、复习调度、数据导出
- 组件级 Provider：单个卡片状态、对话框状态、搜索筛选条件

### 4.3 AI 服务集成

**AIService 核心方法**
```dart
class AIService {
  Future<OCRResult> recognizeImage(Uint8List imageBytes);
  Future<ClassificationResult> classifyText(String text);
  Future<ErrorAnalysis> analyzeError(String text, String userAnswer);
}
```

**优化策略**
- 相同图片识别结果缓存 24 小时
- 支持重试机制（最多 3 次）
- 超时控制（30 秒）

### 4.4 数据库操作

**仓储模式**
```dart
abstract class CardRepository {
  Future<List<FlashCard>> getAllCards();
  Future<List<FlashCard>> getCardsByTag(String tag);
  Future<void> saveCard(FlashCard card);
  Future<void> deleteCard(String id);
}
```

**性能优化**
- tags、createTime、reviewCount 字段建立索引
- 大数据量查询使用分页加载（每页 50 张）

---

## 5. UI/UX 设计

### 5.1 设计规范

**配色方案**
- 主题色：绿色 #58CC02（参考多邻国品牌色）
- 次级色：蓝色 #1CB0F6
- 背景色：白色 #FFFFFF，浅灰色 #F5F5F5
- 文字色：深灰色 #333333，灰色 #666666
- 警告色：红色 #F44336

**尺寸规范**
- 底部导航栏：80dp（含安全区域）
- 卡片圆角：16dp
- 按钮高度：48dp
- 图标尺寸：24dp × 24dp

### 5.2 主界面

**底部导航栏**
- 四个标签页：卡片库、AI 识别中心、复习模式、数据管理
- 选中项高亮显示主题色
- 选中项下方显示 2dp 绿色指示条

### 5.3 卡片库页面

**标题栏**
- 左侧：页面标题"卡片库"（20sp，加粗）
- 右侧：导入按钮（48dp × 48dp）、搜索按钮（48dp × 48dp）

**统计信息栏**
- 高度 48dp，背景色为浅绿色
- 显示"共 X 张卡片"和"已复习 Y 张"

**标签筛选栏**
- 横向滚动，胶囊形状标签
- 标签包括：全部、餐厅、购物、旅行、过去时、现在时、将来时、其他

**卡片网格**
- 每行 2-3 张卡片
- 卡片尺寸：宽度自适应，最小高度 160dp
- 卡片包含：缩略图、中英文文本、标签、置信度

### 5.4 AI 识别中心页面

**待处理图片列表**
- 每项高度 100dp
- 包含：缩略图、状态信息、操作按钮
- 识别中显示圆形进度指示器

**批量识别进度**
- 顶部显示进度条（高度 4dp）
- 显示识别统计："已识别 X / Y 张，成功 Z 张，失败 W 张"

### 5.5 复习模式页面

**复习策略选择器**
- 三个横向排列的策略卡片
- 每个卡片包含：图标、策略名称、卡片数量
- 选中策略边框变为绿色

**复习界面**
- 全屏卡片设计，居中显示
- 卡片尺寸：宽度 90%，最大宽度 600dp，高度自适应
- 翻转动画持续 300ms

**评价按钮**
- 记住（绿色）：卡片向右滑动消失
- 模糊（黄色）：卡片淡出消失
- 忘记（红色）：卡片向左滑动消失，触发错误分析侧边栏

**错误分析侧边栏**
- 从右侧滑出，宽度 85%，最大宽度 400dp
- 包含：错误类型、错误详情、AI 对话
- 底部显示"重新学习"按钮

### 5.6 数据管理页面

**数据统计卡片**
- 高度 120dp，背景色为浅绿色
- 三列显示：总卡片数、已复习数、待复习数

**操作列表**
- 导出、导入、清理三个操作
- 每项高度 64dp，包含图标、操作名称、箭头

### 5.7 悬浮窗设计（Android）

**悬浮窗按钮**
- 半透明圆形按钮，直径 56dp
- 居中显示多邻记图标
- 支持拖动到屏幕任意位置
- 松手后自动吸附到屏幕边缘

**识别流程**
- 点击悬浮窗触发截图
- 屏幕闪烁白色光效
- 显示识别进度提示框（"正在截图..." → "正在识别..." → "识别完成！"）
- 识别成功后卡片库页面刷新

**显示规则**
- 多邻国 APP 前台时显示
- 切换到其他 APP 或桌面时自动隐藏

---

## 6. 错误处理与测试

### 6.1 错误处理

**分层策略**
- 网络层错误：通过 dio 拦截器捕获，提供重试按钮
- 数据库层错误：记录详细日志，提示用户联系开发者
- 业务逻辑层错误：验证检查提前拦截，给出提示
- UI 层错误：全局错误边界，显示错误页面

**日志记录**
- 所有错误日志上传到本地日志文件
- 用户可在设置中导出日志

### 6.2 测试策略

**单元测试**
- 覆盖核心业务逻辑
- 目标覆盖率：80% 以上
- 关键模块：90%

**集成测试**
- 模拟真实用户操作流程
- 测试场景：导入 → 识别 → 编辑 → 复习 → 导出
- 使用 Mock API 避免产生费用

**性能优化**
- AI 识别使用 Isolate 多线程处理
- 数据库查询使用索引优化
- UI 渲染使用 ListView.builder 按需渲染
- 图片显示使用内存缓存
- 启动时间优化：延迟加载非关键模块

---

## 7. 安全性

### 7.1 API Key 管理
- 环境变量配置
- 运行时从安全存储读取
- 避免硬编码

### 7.2 权限管理
- Android：悬浮窗权限、存储权限、相册权限
- iOS：相册权限
- Web：无需特殊权限

### 7.3 数据安全
- 本地 SQLite 存储，不上传云端
- 数据导出前需用户确认
- 敏感操作需二次确认

---

## 8. 后续优化方向

1. **数据同步**：支持云端同步，多设备数据同步
2. **社交功能**：好友 PK、排行榜、分享卡片
3. **智能推荐**：基于学习历史推荐复习内容
4. **语音输入**：支持语音输入答案
5. **离线模式**：AI 识别结果缓存，离线也可复习
6. **主题定制**：支持深色模式、自定义主题色

---

## 9. 附录

### 9.1 硅基流动 API
- 文档：https://docs.siliconflow.cn/cn/api-reference/batch/upload-file
- API Key：已配置在环境变量中

### 9.2 参考资料
- Material Design 3 规范
- Flutter 官方文档
- Riverpod 状态管理最佳实践